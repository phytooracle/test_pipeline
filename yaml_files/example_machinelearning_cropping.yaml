---
tags:
  pipeline: machinelearning_cropping
  description: conf_05_fix
  notes: Initial development of machine learning (ML)-based cropping approach.
  runby: Emmanuel Miguel Gonzalez

modules:
  1:
    container:
      simg_name: heatmap_ml_based_cropping.simg
      dockerhub_path: docker://phytooracle/heatmap_ml_based_cropping:latest
    command: singularity run -B $(pwd):/mnt --pwd /mnt heatmap_ml_based_cropping.simg -p ${PLANT_PATH} -m ${DET_MODEL_PATH} -c 0.5
    distribution_level: plant
    inputs: 
    outputs: [segmentation_pointclouds/$PLANT_NAME/ml_crop.ply,
              plant_reports/$PLANT_NAME/heatmap.jpg,
              plant_reports/$PLANT_NAME/identificaiton.jpg]

  2:
    container: 
      simg_name: dgcnn_single_plant_soil_segmentation_pipeline.simg
      dockerhub_path: docker://phytooracle/dgcnn_single_plant_soil_segmentation_pipeline:latest
    command: singularity run -B $(pwd):/mnt --pwd /mnt dgcnn_single_plant_soil_segmentation_pipeline.simg -p ${PLANT_PATH} --model_path ${SEG_MODEL_PATH} -po segmentation_pointclouds -fo plant_reports -ef ml_crop
    distribution_level: plant
    inputs: [segmentation_pointclouds/$PLANT_NAME/ml_crop.ply]
    outputs: [segmentation_pointclouds/$PLANT_NAME/segmentation_plant.ply, 
              segmentation_pointclouds/$PLANT_NAME/segmentation_soil.ply,
              segmentation_pointclouds/$PLANT_NAME/soil_segmentation.npy,
              plant_reports/$PLANT_NAME/soil_segmentation.csv,
              plant_reports/$PLANT_NAME/soil_segmentation.gif]

  3:
    container: 
      simg_name: 3d_neighbor_removal.simg
      dockerhub_path: docker://phytooracle/3d_neighbor_removal:latest
    command: singularity run -B $(pwd):/mnt --pwd /mnt 3d_neighbor_removal.simg -plant ${PLANT_NAME} -e 0.07 -pod segmentation_pointclouds -fod plant_reports
    distribution_level: plant
    inputs: [segmentation_pointclouds/$PLANT_NAME/segmentation_plant.ply]
    outputs: [plant_reports/$PLANT_NAME/final.gif, 
              segmentation_pointclouds/$PLANT_NAME/final.ply]
  
  4:
    container: 
      simg_name: 3d_segmentation_dashboard_assets.simg
      dockerhub_path: docker://phytooracle/3d_segmentation_dashboard_assets:latest
    command: singularity run -B $(pwd):/mnt --pwd /mnt 3d_segmentation_dashboard_assets.simg -i ${PLANT_PATH} -plant ${PLANT_NAME} -pod segmentation_pointclouds -fod plant_reports
    distribution_level: plant
    inputs: [plant_reports/$PLANT_NAME/, 
             segmentation_pointclouds/$PLANT_NAME/]
    outputs: [plant_reports/$PLANT_NAME/level_1_plant_clip.gif,
              plant_reports/$PLANT_NAME/75_ML_compare.gif,
              plant_reports/$PLANT_NAME/segmentation_dbscan_compare.gif]

workload_manager:
  account: dukepauli
  partition: standard
  job_name: phytooracle_worker
  nodes: 1
  number_tasks: 1
  numer_tasks_per_node: 1
  time_minutes: 1440
  
  mem_per_cpu: 5
  manager_name: 
  min_worker: 100
  max_worker: 500
  cores_per_worker: 4
  worker_timeout_seconds: 300

paths:
  pipeline_outpath:
    pointclouds: segmentation_pointclouds #../{date}/{concatenated_tag}/
    dashboard: plant_reports #../{date}/{concatendated_tag}/

  cyverse: 
    input: 
      basename: /iplant/home/shared/phytooracle/season_10_lettuce_yr_2020/level_1/scanner3DTop/
      subdir: test_set/
      suffix: _test_set.tar.gz
    output: 
      basename: /iplant/home/shared/phytooracle/season_10_lettuce_yr_2020/level_1/scanner3DTop/
      subdir: test_outputs